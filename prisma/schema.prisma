// POS PostgreSQL Schema — Final (locked design)
// Database connection via DATABASE_URL env var. Do not hardcode credentials.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------------------------
// Enums (exact match to locked schema)
// ---------------------------------------------------------------------------

enum OrderStatus {
  pending
  preparing
  ready
  awaiting_payment
  served
  cancelled
}

enum OrderType {
  dine_in
  takeaway
}

enum PaymentMethod {
  cash
  card
  mtn_momo
  airtel_money
}

enum PaymentStatus {
  pending
  completed
  failed
}

enum StaffRole {
  admin
  manager
  cashier
  waiter
  kitchen
}

enum TerminalType {
  POS
  KDS
  manager
  mobile
}

enum TableStatus {
  available
  occupied
}

// ---------------------------------------------------------------------------
// Tables
// ---------------------------------------------------------------------------

model Staff {
  id                    String    @id @default(uuid()) @db.Uuid
  username              String    @unique @db.VarChar(64)
  passwordHash          String    @map("password_hash") @db.VarChar(255)
  fullName              String    @map("full_name") @db.VarChar(255)
  role                  StaffRole
  isActive              Boolean   @default(true) @map("is_active")
  tokenVersion          Int       @default(0) @map("token_version")
  lastPasswordChangeAt  DateTime? @map("last_password_change_at")
  lastForcedLogoutAt    DateTime? @map("last_forced_logout_at")
  lockedUntil           DateTime? @map("locked_until")
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")

  shifts             Shift[]   @relation("ShiftStaff")
  shiftsClosed       Shift[]   @relation("ShiftClosedBy")
  shiftsManagerApproved Shift[] @relation("ShiftManagerApproval")
  ordersCreated    Order[]   @relation("CreatedByStaff")
  ordersAssigned   Order[]   @relation("AssignedWaiter")
  ordersUpdated    Order[]   @relation("UpdatedByStaff")
  payments         Payment[]

  @@index([role])
  @@index([isActive])
}

model Terminal {
  id             String       @id @default(uuid()) @db.Uuid
  code           String       @unique @map("code") @db.VarChar(32)
  name           String       @map("name") @db.VarChar(64)
  type           TerminalType @map("type")
  location       String?      @map("location") @db.VarChar(128)
  isActive       Boolean      @default(true) @map("is_active")
  receiptPrinter Boolean      @default(false) @map("receipt_printer")
  kitchenPrinter Boolean      @default(false) @map("kitchen_printer")
  cashDrawer     Boolean      @default(false) @map("cash_drawer")
  lastSeenAt     DateTime?    @map("last_seen_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  @@index([code])
  @@index([type])
  @@index([isActive])
}

enum PrintJobType {
  receipt
  kitchen_ticket
}

enum PrintJobStatus {
  pending
  success
  failed
}

model PrintJob {
  id           String         @id @default(uuid()) @db.Uuid
  orderId      String         @map("order_id") @db.Uuid
  paymentId    String?        @map("payment_id") @db.Uuid
  type         PrintJobType   @map("type")
  terminalId   String?        @map("terminal_id") @db.VarChar(32)
  deviceId     String?        @map("device_id") @db.VarChar(64)
  status       PrintJobStatus @default(pending) @map("status")
  retryCount   Int            @default(0) @map("retry_count")
  errorMessage String?        @map("error_message") @db.VarChar(512)
  createdAt    DateTime       @default(now()) @map("created_at")
  completedAt  DateTime?      @map("completed_at")

  @@unique([paymentId, type], map: "PrintJob_receipt_once_per_payment")
  @@index([orderId])
  @@index([paymentId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
}

model Shift {
  id                     String    @id @default(uuid()) @db.Uuid
  staffId                String    @map("staff_id") @db.Uuid
  terminalId             String    @map("terminal_id") @db.VarChar(32)
  startTime              DateTime  @map("start_time")
  endTime                DateTime? @map("end_time")
  totalSales             Decimal   @default(0) @map("total_sales") @db.Decimal(12, 2)
  closedByStaffId        String?   @map("closed_by_staff_id") @db.Uuid
  countedCashUgx         Decimal?  @map("counted_cash_ugx") @db.Decimal(12, 2)
  cashVarianceUgx        Decimal?  @map("cash_variance_ugx") @db.Decimal(12, 2)
  managerApprovalStaffId String?   @map("manager_approval_staff_id") @db.Uuid
  createdAt              DateTime  @default(now()) @map("created_at")

  staff                  Staff   @relation("ShiftStaff", fields: [staffId], references: [id])
  closedByStaff          Staff?  @relation("ShiftClosedBy", fields: [closedByStaffId], references: [id])
  managerApprovalStaff   Staff?  @relation("ShiftManagerApproval", fields: [managerApprovalStaffId], references: [id])
  orders                 Order[]
  terminalCashSummaries   TerminalCashSummary[]
  financialSummary        ShiftFinancialSummary?

  @@index([staffId])
  @@index([terminalId])
  @@index([startTime])
}

// Per-terminal cash accountability within a shift (populated on shift close)
model TerminalCashSummary {
  id                String   @id @default(uuid()) @db.Uuid
  shiftId           String   @map("shift_id") @db.Uuid
  terminalId        String   @map("terminal_id") @db.VarChar(32)
  cashSalesUgx      Decimal  @default(0) @map("cash_sales_ugx") @db.Decimal(12, 2)
  dropsUgx          Decimal  @default(0) @map("drops_ugx") @db.Decimal(12, 2)
  adjustmentsUgx    Decimal  @default(0) @map("adjustments_ugx") @db.Decimal(12, 2)
  expectedBalanceUgx Decimal @default(0) @map("expected_balance_ugx") @db.Decimal(12, 2)
  createdAt         DateTime @default(now()) @map("created_at")

  shift Shift @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@unique([shiftId, terminalId])
  @@index([shiftId])
  @@index([terminalId])
}

// Snapshot of financial summary at shift close (reconciliation record)
model ShiftFinancialSummary {
  id                   String   @id @default(uuid()) @db.Uuid
  shiftId              String   @unique @map("shift_id") @db.Uuid
  expectedCashUgx      Decimal  @map("expected_cash_ugx") @db.Decimal(12, 2)
  countedCashUgx       Decimal  @map("counted_cash_ugx") @db.Decimal(12, 2)
  varianceUgx          Decimal  @map("variance_ugx") @db.Decimal(12, 2)
  managerApprovalStaffId String? @map("manager_approval_staff_id") @db.Uuid
  closedAt             DateTime @map("closed_at")

  shift Shift @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  @@index([shiftId])
}

model RestaurantTable {
  id        String      @id @default(uuid()) @db.Uuid
  code      String      @unique @db.VarChar(16)
  capacity  Int?
  images    String[]    @default([])
  status    TableStatus @default(available)
  isActive  Boolean     @default(true) @map("is_active")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  orders         Order[]
  tableOccupancy TableOccupancy[]

  @@index([code])
  @@index([status])
}

// Phase 9: table ownership — which terminal/staff has the table locked for an order
model TableOccupancy {
  id         String   @id @default(uuid()) @db.Uuid
  tableId    String   @unique @map("table_id") @db.Uuid
  orderId    String   @map("order_id") @db.Uuid
  terminalId String   @map("terminal_id") @db.VarChar(32)
  staffId    String   @map("staff_id") @db.Uuid
  lockedAt   DateTime @map("locked_at")

  table RestaurantTable @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@index([tableId])
  @@index([orderId])
  @@index([terminalId])
}

model Product {
  id                 String   @id @default(uuid()) @db.Uuid
  name               String   @db.VarChar(255)
  brand              String?  @db.VarChar(128)
  category           String   @db.VarChar(64)
  section            String   @db.VarChar(64)
  sku                String?  @unique @db.VarChar(64)
  priceUgx           Decimal  @map("price_ugx") @db.Decimal(12, 2)
  originalPriceUgx   Decimal? @map("original_price_ugx") @db.Decimal(12, 2)
  sizes              String[]
  colors             String[]
  images             String[]
  description        String?
  condition          String?  @db.VarChar(32)
  stockQty           Int      @default(0) @map("stock_qty")
  isActive           Boolean  @default(true) @map("is_active")
  isHappyHour        Boolean  @default(false) @map("is_happy_hour")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  orderItems OrderItem[]

  @@index([category, section])
  @@index([sku])
  @@index([isActive])
}

model Order {
  id                 String       @id @default(uuid()) @db.Uuid
  orderNumber        String       @unique @map("order_number") @db.VarChar(32)
  orderType          OrderType    @map("order_type")
  tableId            String?      @map("table_id") @db.Uuid
  shiftId            String       @map("shift_id") @db.Uuid
  createdByStaffId   String       @map("created_by_staff_id") @db.Uuid
  assignedWaiterId   String?      @map("assigned_waiter_id") @db.Uuid
  terminalId         String       @map("terminal_id") @db.VarChar(32)
  status             OrderStatus  @default(pending)
  subtotalUgx        Decimal      @map("subtotal_ugx") @db.Decimal(12, 2)
  taxUgx             Decimal      @default(0) @map("tax_ugx") @db.Decimal(12, 2)
  totalUgx           Decimal      @map("total_ugx") @db.Decimal(12, 2)
  notes              String?
  customerName       String?      @map("customer_name") @db.VarChar(255)
  customerPhone      String?      @map("customer_phone") @db.VarChar(32)
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")
  updatedByStaffId   String?      @map("updated_by_staff_id") @db.Uuid
  servedAt           DateTime?    @map("served_at")
  sentToKitchenAt    DateTime?    @map("sent_to_kitchen_at")

  table            RestaurantTable? @relation(fields: [tableId], references: [id])
  shift            Shift            @relation(fields: [shiftId], references: [id])
  createdByStaff   Staff            @relation("CreatedByStaff", fields: [createdByStaffId], references: [id])
  assignedWaiter   Staff?           @relation("AssignedWaiter", fields: [assignedWaiterId], references: [id])
  updatedByStaff   Staff?           @relation("UpdatedByStaff", fields: [updatedByStaffId], references: [id])
  orderItems       OrderItem[]
  payments         Payment[]

  @@index([shiftId])
  @@index([tableId])
  @@index([status])
  @@index([assignedWaiterId])
  @@index([createdAt(sort: Desc)])
}

model OrderItem {
  id           String   @id @default(uuid()) @db.Uuid
  orderId      String   @map("order_id") @db.Uuid
  productId    String   @map("product_id") @db.Uuid
  quantity     Int
  unitPriceUgx Decimal  @map("unit_price_ugx") @db.Decimal(12, 2)
  lineTotalUgx Decimal  @map("line_total_ugx") @db.Decimal(12, 2)
  size         String?  @db.VarChar(32)
  modifier     String?  @db.VarChar(64)
  notes        String?
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model Payment {
  id                 String         @id @default(uuid()) @db.Uuid
  orderId            String         @map("order_id") @db.Uuid
  amountUgx          Decimal        @map("amount_ugx") @db.Decimal(12, 2)
  changeUgx          Decimal?       @map("change_ugx") @db.Decimal(12, 2)
  method             PaymentMethod
  status             PaymentStatus  @default(pending)
  reference          String?        @db.VarChar(128)
  externalReference  String?       @unique @map("external_reference") @db.VarChar(255)
  createdByStaffId   String         @map("created_by_staff_id") @db.Uuid
  terminalId         String?        @map("terminal_id") @db.VarChar(32)
  originalPaymentId String?        @map("original_payment_id") @db.Uuid
  createdAt          DateTime       @default(now()) @map("created_at")

  order            Order   @relation(fields: [orderId], references: [id])
  createdByStaff   Staff   @relation(fields: [createdByStaffId], references: [id])
  originalPayment Payment? @relation("RefundOf", fields: [originalPaymentId], references: [id])
  refunds          Payment[] @relation("RefundOf")

  @@index([orderId])
  @@index([status])
  @@index([method])
  @@index([createdAt])
  @@index([originalPaymentId])
}

// Phase 8: idempotency for offline sync replay (clientRequestId).
model IdempotencyRecord {
  id              String   @id @default(uuid()) @db.Uuid
  clientRequestId String   @unique @map("client_request_id") @db.VarChar(64)
  resourceType    String   @map("resource_type") @db.VarChar(32)
  responseJson    Json     @map("response_json")
  createdAt       DateTime @default(now()) @map("created_at")

  @@index([clientRequestId])
}

// Append-only; no update/delete from application.
model AuditLog {
  id           String   @id @default(uuid()) @db.Uuid
  staffId      String?  @map("staff_id") @db.Uuid
  terminalId   String?  @map("terminal_id") @db.VarChar(32)
  actionType   String   @map("action_type") @db.VarChar(64)
  entityType   String   @map("entity_type") @db.VarChar(32)
  entityId     String?  @map("entity_id") @db.Uuid
  previousState Json?   @map("previous_state")
  newState     Json?    @map("new_state")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([staffId])
  @@index([terminalId])
  @@index([actionType])
  @@index([entityType])
  @@index([entityId])
  @@index([createdAt])
}

// Phase 10: backup metadata
enum DatabaseBackupType {
  FULL
  INCREMENTAL
}

enum DatabaseBackupStatus {
  SUCCESS
  FAILED
}

model DatabaseBackup {
  id         String              @id @default(uuid()) @db.Uuid
  filename   String              @map("filename") @db.VarChar(255)
  sizeBytes  BigInt?             @map("size_bytes")
  createdAt  DateTime            @default(now()) @map("created_at")
  type       DatabaseBackupType   @map("type")
  status     DatabaseBackupStatus @map("status")

  @@index([createdAt])
  @@index([type])
  @@index([status])
}

// Phase 10: system configuration (backup retention, etc.)
model SystemConfig {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique @db.VarChar(64)
  value     String   @map("value") @db.VarChar(512)
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([key])
}
