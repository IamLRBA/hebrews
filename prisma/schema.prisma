// POS PostgreSQL Schema â€” Final (locked design)
// Database connection via DATABASE_URL env var. Do not hardcode credentials.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------------------------
// Enums (exact match to locked schema)
// ---------------------------------------------------------------------------

enum OrderStatus {
  pending
  preparing
  ready
  served
  cancelled
}

enum OrderType {
  dine_in
  takeaway
}

enum PaymentMethod {
  cash
  card
  mtn_momo
  airtel_money
}

enum PaymentStatus {
  pending
  completed
  failed
}

enum StaffRole {
  admin
  manager
  cashier
  kitchen
}

enum TableStatus {
  available
  occupied
}

// ---------------------------------------------------------------------------
// Tables
// ---------------------------------------------------------------------------

model Staff {
  id           String    @id @default(uuid()) @db.Uuid
  username     String    @unique @db.VarChar(64)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  fullName     String   @map("full_name") @db.VarChar(255)
  role         StaffRole
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  shifts          Shift[]   @relation("ShiftStaff")
  shiftsClosed    Shift[]   @relation("ShiftClosedBy")
  ordersCreated   Order[]   @relation("CreatedByStaff")
  ordersUpdated   Order[]   @relation("UpdatedByStaff")
  payments        Payment[]

  @@index([role])
  @@index([isActive])
}

model Shift {
  id                String    @id @default(uuid()) @db.Uuid
  staffId           String    @map("staff_id") @db.Uuid
  terminalId        String    @map("terminal_id") @db.VarChar(32)
  startTime         DateTime  @map("start_time")
  endTime           DateTime? @map("end_time")
  totalSales        Decimal   @default(0) @map("total_sales") @db.Decimal(12, 2)
  closedByStaffId   String?   @map("closed_by_staff_id") @db.Uuid
  countedCashUgx    Decimal?  @map("counted_cash_ugx") @db.Decimal(12, 2)
  cashVarianceUgx   Decimal?  @map("cash_variance_ugx") @db.Decimal(12, 2)
  createdAt         DateTime  @default(now()) @map("created_at")

  staff         Staff   @relation("ShiftStaff", fields: [staffId], references: [id])
  closedByStaff Staff?  @relation("ShiftClosedBy", fields: [closedByStaffId], references: [id])
  orders        Order[]

  @@index([staffId])
  @@index([terminalId])
  @@index([startTime])
}

model RestaurantTable {
  id        String      @id @default(uuid()) @db.Uuid
  code      String      @unique @db.VarChar(16)
  capacity  Int?
  images    String[]    @default([])
  status    TableStatus @default(available)
  isActive  Boolean     @default(true) @map("is_active")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  orders Order[]

  @@index([code])
  @@index([status])
}

model Product {
  id                 String   @id @default(uuid()) @db.Uuid
  name               String   @db.VarChar(255)
  brand              String?  @db.VarChar(128)
  category           String   @db.VarChar(64)
  section            String   @db.VarChar(64)
  sku                String?  @unique @db.VarChar(64)
  priceUgx           Decimal  @map("price_ugx") @db.Decimal(12, 2)
  originalPriceUgx   Decimal? @map("original_price_ugx") @db.Decimal(12, 2)
  sizes              String[]
  colors             String[]
  images             String[]
  description        String?
  condition          String?  @db.VarChar(32)
  stockQty           Int      @default(0) @map("stock_qty")
  isActive           Boolean  @default(true) @map("is_active")
  isHappyHour        Boolean  @default(false) @map("is_happy_hour")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  orderItems OrderItem[]

  @@index([category, section])
  @@index([sku])
  @@index([isActive])
}

model Order {
  id                String      @id @default(uuid()) @db.Uuid
  orderNumber       String      @unique @map("order_number") @db.VarChar(32)
  orderType         OrderType   @map("order_type")
  tableId           String?     @map("table_id") @db.Uuid
  shiftId           String      @map("shift_id") @db.Uuid
  createdByStaffId  String      @map("created_by_staff_id") @db.Uuid
  terminalId        String      @map("terminal_id") @db.VarChar(32)
  status            OrderStatus @default(pending)
  subtotalUgx       Decimal     @map("subtotal_ugx") @db.Decimal(12, 2)
  taxUgx            Decimal     @default(0) @map("tax_ugx") @db.Decimal(12, 2)
  totalUgx          Decimal     @map("total_ugx") @db.Decimal(12, 2)
  notes             String?
  customerName      String?     @map("customer_name") @db.VarChar(255)
  customerPhone     String?     @map("customer_phone") @db.VarChar(32)
  createdAt         DateTime   @default(now()) @map("created_at")
  updatedAt         DateTime   @updatedAt @map("updated_at")
  updatedByStaffId  String?     @map("updated_by_staff_id") @db.Uuid

  table           RestaurantTable? @relation(fields: [tableId], references: [id])
  shift           Shift            @relation(fields: [shiftId], references: [id])
  createdByStaff  Staff            @relation("CreatedByStaff", fields: [createdByStaffId], references: [id])
  updatedByStaff  Staff?           @relation("UpdatedByStaff", fields: [updatedByStaffId], references: [id])
  orderItems      OrderItem[]
  payments        Payment[]

  @@index([shiftId])
  @@index([tableId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

model OrderItem {
  id           String   @id @default(uuid()) @db.Uuid
  orderId      String   @map("order_id") @db.Uuid
  productId    String   @map("product_id") @db.Uuid
  quantity     Int
  unitPriceUgx Decimal  @map("unit_price_ugx") @db.Decimal(12, 2)
  lineTotalUgx Decimal  @map("line_total_ugx") @db.Decimal(12, 2)
  size         String?  @db.VarChar(32)
  modifier     String?  @db.VarChar(64)
  notes        String?
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
}

model Payment {
  id                String        @id @default(uuid()) @db.Uuid
  orderId           String        @map("order_id") @db.Uuid
  amountUgx        Decimal       @map("amount_ugx") @db.Decimal(12, 2)
  method           PaymentMethod
  status           PaymentStatus @default(pending)
  reference        String?       @db.VarChar(128)
  externalReference String?      @unique @map("external_reference") @db.VarChar(255)
  createdByStaffId String        @map("created_by_staff_id") @db.Uuid
  createdAt        DateTime      @default(now()) @map("created_at")

  order          Order @relation(fields: [orderId], references: [id])
  createdByStaff Staff @relation(fields: [createdByStaffId], references: [id])

  @@index([orderId])
  @@index([status])
  @@index([method])
  @@index([createdAt])
}
